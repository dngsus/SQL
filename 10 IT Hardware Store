/* This project concerns a computer hardware and peripheral manufacturer. */

/* Data source: db_dump_version_2.sql from https://codebasics.io/resources/end-to-end-sales-insights-project-using-tableau */

/* SECTION A - Data cleaning and transformation: */

/* (A.1.01) Renaming certain profit-related columns incorrectly named from source: */

/* alter table transactions rename column profit_margin to profit;

-- alter table transactions rename column profit_margin_percentage to profit_margin;

-- alter table transactions rename column cost_price to cost;

-- alter table transactions rename column sales_amount to sale_price;

-- alter table customers rename column custmer_name to customer_name;

-- alter table markets rename column markets_code to market_code;

-- alter table markets rename column markets_name to market_name;

*/

/* (A.1.02) Mismatched currencies: */

/* Adding an ID column to transactions so as to better identify columns in the subsequent query:

-- ALTER TABLE transactions ADD transaction_code int NOT NULL AUTO_INCREMENT primary key first;

-- Identifying transactions with the 'wrong' currency and correcting them based on historical FX figures.
-- From inspection, it is apparent that "sale_price" is incorrectly listed under USD, but not other columns.
-- Hence the historic FX rate used may be reverse engineered. In any case, this FX_rate need not even be used to correct the figures (sales prices).

*/

/* SELECT transaction_code, currency, sale_price, profit_margin, profit, cost, sales_qty FROM sales.transactions where currency = "USD";

-- select transaction_code, profit + cost as new_sale_price, sale_price, (profit + cost) / sale_price as FX_rate from transactions where currency = "USD";

-- update transactions set sale_price = 37500 where transaction_code = 135589;

-- update transactions set sale_price = 18750 where transaction_code = 135671;

-- update transactions set currency = "INR" where transaction_code in (135589, 135671);
*/

/* (A.1.03) Typically, profit margins are expressed as a %age: */

-- update transactions set profit_margin = profit_margin * 100;

/* (A.1.04) Adding by-quarter columns to date table for future analysis: */

/* Alter table date add year_quarter char(7);

-- update date set year_quarter = concat(year, "-Q", quarter(date));

-- alter table date add quarter int after month_name;

-- update date set quarter = quarter(date);

*/

/* (A.1.05) Missing product_codes filled in: */

/* insert into products values ("Prod280", "Unknown");
insert into products values ("Prod281", "Unknown");
insert into products values ("Prod282", "Unknown");
insert into products values ("Prod283", "Unknown");
insert into products values ("Prod284", "Unknown");
insert into products values ("Prod285", "Unknown");
insert into products values ("Prod286", "Unknown");
insert into products values ("Prod287", "Unknown");
insert into products values ("Prod288", "Unknown");
insert into products values ("Prod289", "Unknown");
insert into products values ("Prod290", "Unknown");
insert into products values ("Prod291", "Unknown");
insert into products values ("Prod292", "Unknown");
insert into products values ("Prod293", "Unknown");
insert into products values ("Prod294", "Unknown");
insert into products values ("Prod295", "Unknown");
insert into products values ("Prod296", "Unknown");
insert into products values ("Prod297", "Unknown");
insert into products values ("Prod298", "Unknown");
insert into products values ("Prod299", "Unknown");
insert into products values ("Prod300", "Unknown");
insert into products values ("Prod301", "Unknown");
insert into products values ("Prod302", "Unknown");
insert into products values ("Prod303", "Unknown");
insert into products values ("Prod304", "Unknown");
insert into products values ("Prod305", "Unknown");
insert into products values ("Prod306", "Unknown");
insert into products values ("Prod307", "Unknown");
insert into products values ("Prod308", "Unknown");
insert into products values ("Prod309", "Unknown");
insert into products values ("Prod310", "Unknown");
insert into products values ("Prod311", "Unknown");
insert into products values ("Prod312", "Unknown");
insert into products values ("Prod313", "Unknown");
insert into products values ("Prod314", "Unknown");
insert into products values ("Prod315", "Unknown");
insert into products values ("Prod316", "Unknown");
insert into products values ("Prod317", "Unknown");
insert into products values ("Prod318", "Unknown");
insert into products values ("Prod319", "Unknown");
insert into products values ("Prod320", "Unknown");
insert into products values ("Prod321", "Unknown");
insert into products values ("Prod322", "Unknown");
insert into products values ("Prod323", "Unknown");
insert into products values ("Prod324", "Unknown");
insert into products values ("Prod325", "Unknown");
insert into products values ("Prod326", "Unknown");
insert into products values ("Prod327", "Unknown");
insert into products values ("Prod328", "Unknown");
insert into products values ("Prod329", "Unknown");
insert into products values ("Prod330", "Unknown");
insert into products values ("Prod331", "Unknown");
insert into products values ("Prod332", "Unknown");
insert into products values ("Prod333", "Unknown");
insert into products values ("Prod334", "Unknown");
insert into products values ("Prod335", "Unknown");
insert into products values ("Prod336", "Unknown");
insert into products values ("Prod337", "Unknown");
insert into products values ("Prod338", "Unknown");
insert into products values ("Prod339", "Unknown");
*/


/* SECTION B - Exploring revenues: */

/* (B.1) Revenues over time : */

/* (B.1.01) Overall: */

SELECT 
    SUM(sale_price) AS total_rev_to_date
FROM
    transactions;

/* (B.1.02) By year: */

select sum(sale_price) as total_rev, year(order_date) as year, rank() over(order by sum(sale_price) desc) as rev_rank from transactions group by 2 order by 2;

/* (B.1.03) By year-quarter: */

select year_quarter, sum(sale_price) as total_rev,
rank() over(order by sum(sale_price)) as overall_rev_rank,
quarter(order_date) as quarter,
year(order_date) as year,
rank() over(partition by left(year_quarter, 4) order by sum(sale_price)) as within_year_rank
from transactions t join date d on t.order_date = d.date group by 1, 4, 5 order by 1;

-- Check, knowing all orders in 2017 occured in Q4:

select sum(sale_price) as total_rev_2017_Q4 from transactions t join date d on t.order_date = d.date where year(order_date) = 2017;

/* (B.1.04) By aggregated quarter: */

with temp as
	(select quarter,
    count(distinct year_quarter) as occurences_of_quarter
    from date
    group by 1)
    
select quarter,
sum(sale_price) as total_rev,
rank() over(order by sum(sale_price) desc) as overall_rev_rank,
occurences_of_quarter,
(sum(sale_price) / occurences_of_quarter) as avg_rev,
rank() over(order by (sum(sale_price) / occurences_of_quarter) desc) as avg_rev_rank
from
	temp join transactions t on temp.quarter = quarter(t.order_date)
group by 1
order by 1;




/* (B.2) Revenues by customer: */

/* (B.2.01) Overall: */

SELECT 
    c.customer_code, customer_name, SUM(sale_price) AS spend, rank() over(order by sum(sale_price) desc) as spend_rank
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 4;

/* (B.2.01a) Overall - Top 5 customers by spending: */

SELECT 
    c.customer_code, customer_name, SUM(sale_price) AS spend
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 3 DESC
LIMIT 5;

/* (B.2.01b) Overall - Bottom 5 customers by spending: */

SELECT 
    c.customer_code, customer_name, SUM(sale_price) AS spend
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 3
LIMIT 5;

/* (B.2.02) By customer_type: */

SELECT 
    customer_type,
    SUM(sale_price) AS total_spend,
    COUNT(DISTINCT c.customer_name) AS num_estab,
    SUM(sale_price) / COUNT(DISTINCT c.customer_name) AS avg_spend_per_estab
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1
ORDER BY 2 DESC;



/* (B.3) Revenues by markets (geography): */

/* (B.3.01) Overall: */

SELECT 
    m.market_name, SUM(sale_price) AS spend, rank() over(order by sum(sale_price) desc) as spend_rank
FROM
    markets m
        JOIN
    transactions t ON m.market_code= t.market_code
GROUP BY 1
ORDER BY 3;

/* (B.3.02) By zone: */

SELECT 
    zone,
    SUM(sale_price) AS total_spend,
    rank() over (order by SUM(sale_price) desc) as total_spend_rank,
    COUNT(DISTINCT m.market_name) AS num_cities,
    SUM(sale_price) / COUNT(DISTINCT m.market_name) AS spend_per_city,
    rank() over (order by SUM(sale_price) / COUNT(DISTINCT m.market_name) desc) as avg_spend_rank
FROM
    markets m
        JOIN
    transactions t ON m.market_code = t.market_code
GROUP BY 1
ORDER BY 2 DESC;



/* (B.4) Revenues by product: */

/* (B.4.01) Overall: */

SELECT 
    p.product_code, SUM(sale_price) AS rev, rank() over(order by sum(sale_price) desc) as rev_rank
FROM
    products p
        JOIN
    transactions t ON p.product_code= t.product_code
GROUP BY 1
ORDER BY 3;

/* (B.4.01a) Overall - Top 5 products by revenue: */

SELECT 
     p.product_code, SUM(sale_price) AS rev
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2
 DESC
LIMIT 5;

/* (B.4.01b) Overall - Bottom 5 products by revenue: */

SELECT 
     p.product_code, SUM(sale_price) AS rev
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2
LIMIT 5;

/* (B.4.02) By product_type: */

SELECT 
    product_type,
    SUM(sale_price) AS total_rev,
    COUNT(DISTINCT p.product_code) AS num_prods,
    SUM(sale_price) / COUNT(DISTINCT p.product_code) AS rev_per_type
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2 DESC;




/* SECTION C - Exploring activity (sales quantities = purchase quantities): */

/* (C.1) Activity over time: */ 

/* (C.1.01) Overall: */

select sum(sales_qty) as sales from transactions;

/* (C.1.02) By year: */

select count(transaction_code) as num_trans, year(order_date), rank() over(order by count(transaction_code) desc) as trans_rank from transactions group by 2 order by 2;

/* (C.1.03) By year-quarter: */

select year_quarter,
count(transaction_code) as num_trans,
rank() over(order by count(transaction_code) desc) as overall_trans_rank,
year(order_date) as year,
quarter(order_date) as quarter,
rank() over(partition by left(year_quarter, 4) order by count(transaction_code) desc) as within_year_rank
from transactions t join date d on t.order_date = d.date group by 1, 4, 5 order by 1;

-- Check, knowing all orders in 2017 occured in Q4:

select count(transaction_code) as total_trans_2017_Q4 from transactions t join date d on t.order_date = d.date where year(order_date) = 2017;

/* (C.1.04) By aggregated quarter: */

with temp as
	(select quarter,
    count(distinct year_quarter) as occurences_of_quarter
    from date
    group by 1)
    
select quarter,
count(transaction_code)  as total_trans,
rank() over(order by count(transaction_code) desc) as overall_trans_rank,
occurences_of_quarter,
(count(transaction_code)  / occurences_of_quarter) as avg_trans,
rank() over(order by (count(transaction_code)  / occurences_of_quarter) desc) as avg_trans_rank
from
	temp join transactions t on temp.quarter = quarter(t.order_date)
group by 1
order by 1;




/* (C.2) Activity by customer: */

/* (C.2.01) Overall: */

SELECT 
    c.customer_code, customer_name, count(transaction_code) AS num_trans, rank() over(order by count(transaction_code) desc) as trans_rank
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 4;

/* (C.2.01a) Overall - Top 5 customers by spending: */

SELECT 
    c.customer_code, customer_name, count(transaction_code) AS trans
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 3 DESC
LIMIT 5;

/* (C.2.01b) Overall - Bottom 5 customers by spending: */

SELECT 
    c.customer_code,
    customer_name,
    COUNT(transaction_code) AS trans
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 3
LIMIT 5;

/* (C.2.02) By customer_type: */

SELECT 
    customer_type,
    count(transaction_code) AS total_trans,
    COUNT(DISTINCT c.customer_name) AS num_estab,
    count(transaction_code) / COUNT(DISTINCT c.customer_name) AS avg_trans_per_estab
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1
ORDER BY 2 DESC;




/* (C.3) Activity by markets (geography): */

/* (C.3.01) Overall: */

SELECT 
    m.market_name, count(transaction_code) AS num_trans, rank() over(order by count(transaction_code) desc) as trans_rank
FROM
    markets m
        JOIN
    transactions t ON m.market_code= t.market_code
GROUP BY 1
ORDER BY 3;

/* (C.3.02) By zone: */

SELECT 
    zone,
    count(transaction_code) AS num_trans,
    rank() over (order by count(transaction_code)desc) as total_trans_rank,
    COUNT(DISTINCT m.market_name) AS num_cities,
    count(transaction_code) / COUNT(DISTINCT m.market_name) AS trans_per_city,
    rank() over (order by (count(transaction_code)) / COUNT(DISTINCT m.market_name) desc) as avg_trans_rank
FROM
    markets m
        JOIN
    transactions t ON m.market_code = t.market_code
GROUP BY 1
ORDER BY 2 DESC;




/* (C.4) Activity by product: */

/* (C.4.01) Overall: */

SELECT 
    p.product_code, count(transaction_code) AS num_purchases, rank() over(order by count(transaction_code) desc) as purchase_rank
FROM
    products p
        JOIN
    transactions t ON p.product_code= t.product_code
GROUP BY 1
ORDER BY 3;

/* (C.4.01a) Overall - Top 5 products by activity: */

SELECT 
     p.product_code, count(transaction_code) AS num_purchases
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2
 DESC
LIMIT 5;

/* (C.4.01b) Overall - Bottom 5 products by activity: */

SELECT 
     p.product_code, count(transaction_code) AS num_purchases
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2
LIMIT 5;

/* (C.4.02) By product_type: */

SELECT 
    product_type,
    count(transaction_code) AS num_purchases,
    COUNT(DISTINCT p.product_code) AS num_prods,
    count(transaction_code) / COUNT(DISTINCT p.product_code) AS purchases_per_prod
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2 DESC;




/* SECTION D - Exploring revenue per transaction = spend per transaction: */

/* (D.1) Rev/trans over time: */ 

/* (D.1.01) Overall: */

SELECT 
    SUM(sale_price) / COUNT(transaction_code) AS rev_per_trans_to_date
FROM
    transactions;

/* (D.1.02) By year: */

select year(order_date), sum(sale_price) / count(transaction_code) as rev_per_trans, rank() over(order by sum(sale_price) / count(transaction_code) desc) as metric_rank from transactions group by 1 order by 1;

/* (D.1.03) By year-quarter: */

select year_quarter,
sum(sale_price) / count(transaction_code) as rev_per_trans,
rank() over(order by sum(sale_price) / count(transaction_code) desc) as overall_rank,
year(order_date) as year,
quarter(order_date) as quarter,
rank() over(partition by left(year_quarter, 4) order by sum(sale_price) / count(transaction_code) desc) as within_year_rank
from transactions t join date d on t.order_date = d.date group by 1, 4, 5 order by 1;

-- Check, knowing all orders in 2017 occured in Q4:

select sum(sale_price) / count(transaction_code) as metric_2017_Q4 from transactions t join date d on t.order_date = d.date where year(order_date) = 2017;

/* (D.1.04) By aggregated quarter: */

with temp as
	(select quarter,
    count(distinct year_quarter) as occurences_of_quarter,
    sum(sale_price) / count(transaction_code) as rev_per_trans
    from date d join transactions t on d.date = t.order_date
    group by 1)
    
select quarter,
avg(rev_per_trans)  as rev_per_trans,
rank() over(order by rev_per_trans desc) as overall_rank,
occurences_of_quarter,
(rev_per_trans / occurences_of_quarter) as avg_per_quarter,
rank() over(order by (rev_per_trans / occurences_of_quarter) desc) as per_quarter_rank
from
	temp --  transactions t on temp.quarter = quarter(t.order_date)
group by 1
order by 1;




/* (D.2) Spend/trans by customer: */

/* (D.2.01) Overall: */

SELECT 
    c.customer_code, customer_name,  sum(sale_price) / count(transaction_code) AS spend_per_trans, rank() over(order by  sum(sale_price) / count(transaction_code) desc) as metric_rank
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 4;

/* (D.2.01a) Overall - Top 5 customers by spend/trans: */

SELECT 
    c.customer_code, customer_name,  sum(sale_price) / count(transaction_code) AS spend_per_trans
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 3 DESC
LIMIT 5;

/* (D.2.01b) Overall - Bottom 5 customers by spend/trans: */

SELECT 
    c.customer_code,
    customer_name,
    sum(sale_price) / count(transaction_code) AS spend_per_trans
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 3
LIMIT 5;

/* (D.2.02) By customer_type: */

SELECT 
    customer_type,
    sum(sale_price) / count(transaction_code) AS spend_per_trans,
    COUNT(DISTINCT c.customer_name) AS num_estab,
    (sum(sale_price) / count(transaction_code)) / COUNT(DISTINCT c.customer_name) AS avg_per_estab
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1
ORDER BY 2 DESC;




/* (D.3) Spend/trans by markets (geography): */

/* (D.3.01) Overall: */

SELECT 
    m.market_name, sum(sale_price) / count(transaction_code) AS spend_per_trans, rank() over(order by (sum(sale_price) / count(transaction_code)) desc) as metric_rank
FROM
    markets m
        JOIN
    transactions t ON m.market_code= t.market_code
GROUP BY 1
ORDER BY 3;



/* (D.3.02) By zone: */

SELECT 
    zone,
    sum(sale_price) / count(transaction_code) AS spend_per_trans,
    rank() over (order by sum(sale_price) / count(transaction_code) desc) as overall_metric_rank,
    COUNT(DISTINCT m.market_name) AS num_cities,
    (sum(sale_price) / count(transaction_code)) / COUNT(DISTINCT m.market_name) AS metric_per_city,
    rank() over (order by ((sum(sale_price) / count(transaction_code)) / COUNT(DISTINCT m.market_name)) desc) as per_city_rank
FROM
    markets m
        JOIN
    transactions t ON m.market_code = t.market_code
GROUP BY 1
ORDER BY 2 DESC;




/* (D.4) Rev/trans by product: */

-- For the sake of practice, listed below. However, commented out as it does not make obvious sense as a metric, since it involves an interaction with price.
-- I.e. To accumulate the same revenue per transaction as a more pricey item, a relatively cheap item must be purchased in multiples. However, there is no natural law to generally encourage cheaper products be purchased in mulitples.

/* (D.4.01) Overall: */

/* SELECT 
    p.product_code, sum(sale_price) / count(transaction_code) AS rev_per_trans, rank() over(order by (sum(sale_price) / count(transaction_code)) desc) as metric_rank
FROM
    products p
        JOIN
    transactions t ON p.product_code= t.product_code
GROUP BY 1
ORDER BY 3; */

/* (D.4.01a) Overall - Top 5 products by rev/trans: */

/* SELECT 
     p.product_code, sum(sale_price) / count(transaction_code) AS rev_per_trans
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2
 DESC
LIMIT 5; */

/* (D.4.01b) Overall - Bottom 5 products by rev/trans: */

/* SELECT 
     p.product_code, sum(sale_price) / count(transaction_code) AS rev_per_trans
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2
LIMIT 5; */

/* (D.4.02) By product_type: */

/* SELECT 
    product_type,
    sum(sale_price) / count(transaction_code) AS rev_per_trans,
    COUNT(DISTINCT p.product_code) AS num_prods,
    (sum(sale_price) / count(transaction_code)) / COUNT(DISTINCT p.product_code) AS metric_per_type
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2 DESC; */




/* SECTION E - Exploring profit: */

/* (E.1) Profit  over time: */ 

/* (E.1.01) Overall: */

SELECT 
    SUM(profit) AS profit_to_date
FROM
    transactions;

/* (E.1.02) By year: */

select sum(profit) as profit, year(order_date), rank() over(order by sum(profit) desc) as profit_rank from transactions group by 2 order by 2;

/* (E.1.03) By year-quarter: */

select year_quarter,
sum(profit) as profit,
rank() over(order by sum(profit) desc) as overall_profit_rank,
year(order_date) as year,
quarter(order_date) as quarter,
rank() over(partition by left(year_quarter, 4) order by sum(profit) desc) as within_year_rank
from transactions t join date d on t.order_date = d.date group by 1, 4, 5 order by 1;

-- Check, knowing all orders in 2017 occured in Q4:

select sum(profit) as total_trans_2017_Q4 from transactions t join date d on t.order_date = d.date where year(order_date) = 2017;

/* (E.1.04) By aggregated quarter: */

with temp as
	(select quarter,
    count(distinct year_quarter) as occurences_of_quarter
    from date
    group by 1)
    
select quarter,
sum(profit)  as profit,
rank() over(order by sum(profit) desc) as overall_profit_rank,
occurences_of_quarter,
(sum(profit) / occurences_of_quarter) as avg_profit,
rank() over(order by (sum(profit)  / occurences_of_quarter) desc) as avg_profit_rank
from
	temp join transactions t on temp.quarter = quarter(t.order_date)
group by 1
order by 1;




/* (E.2) Profit by customer: */

/* (E.2.01) Overall: */

SELECT 
    c.customer_code, customer_name, sum(profit) as profit, rank() over(order by count(transaction_code) desc) as profit_rank
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 4;

/* (E.2.01a) Overall - Top 5 customers by profit: */

SELECT 
    c.customer_code, customer_name, sum(profit) as profit
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 3 DESC
LIMIT 5;

/* (E.2.01b) Overall - Bottom 5 customers by profit: */

SELECT 
    c.customer_code,
    customer_name,
    sum(profit) as profit
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 3
LIMIT 5;

/* (E.2.02) By customer_type: */

SELECT 
    customer_type,
    sum(profit) as overall_profit,
    COUNT(DISTINCT c.customer_name) AS num_estab,
    sum(profit) / COUNT(DISTINCT c.customer_name) AS profit_per_estab
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1
ORDER BY 2 DESC;




/* (E.3) Profit by markets (geography): */

/* (E.3.01) Overall: */

SELECT 
    m.market_name, sum(profit) as profit, rank() over(order by sum(profit) desc) as profit_rank
FROM
    markets m
        JOIN
    transactions t ON m.market_code= t.market_code
GROUP BY 1
ORDER BY 3;

/* (E.3.02) By zone: */

SELECT 
    zone,
    sum(profit) as profit,
    rank() over (order by sum(profit) desc) as overall_profit_rank,
    COUNT(DISTINCT m.market_name) AS num_cities,
    sum(profit) / COUNT(DISTINCT m.market_name) AS profit_per_city,
    rank() over (order by (sum(profit)) / COUNT(DISTINCT m.market_name) desc) as per_city_profit_rank
FROM
    markets m
        JOIN
    transactions t ON m.market_code = t.market_code
GROUP BY 1
ORDER BY 2 DESC;




/* (E.4) Profit by product: */

/* (E.4.01) Overall: */

SELECT 
    p.product_code, sum(profit) as profit, rank() over(order by sum(profit) desc) as profit_rank
FROM
    products p
        JOIN
    transactions t ON p.product_code= t.product_code
GROUP BY 1
ORDER BY 3;

/* (E.4.01a) Overall - Top 5 products by profit: */

SELECT 
     p.product_code, sum(profit) as profit
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2
 DESC
LIMIT 5;

/* (E.4.01b) Overall - Bottom 5 products by profit: */

SELECT 
     p.product_code, sum(profit) as profit
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2
LIMIT 5;

/* (E.4.02) By product_type: */

SELECT 
    product_type,
    sum(profit) as profit,
    COUNT(DISTINCT p.product_code) AS num_prods,
    sum(profit) / COUNT(DISTINCT p.product_code) AS profit_per_prod
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2 DESC;






/* SECTION F - Exploring profit margins (%): */

/* (F.1) Profit margin over time: */ 

/* (F.1.01) Overall: */

select avg(profit_margin) as prof_marg_to_date from transactions;

/* (F.1.02) By year: */

select avg(profit_margin) as prof_marg, year(order_date), rank() over(order by avg(profit_margin) desc) as profit_rank from transactions group by 2 order by 2;

/* (F.1.03) By year-quarter: */

select year_quarter,
avg(profit_margin) as prof_marg,
rank() over(order by sum(profit) desc) as overall_prof_marg_rank,
year(order_date) as year,
quarter(order_date) as quarter,
rank() over(partition by left(year_quarter, 4) order by avg(profit_margin) desc) as within_year_rank
from transactions t join date d on t.order_date = d.date group by 1, 4, 5 order by 1;

-- Check, knowing all orders in 2017 occured in Q4:

select avg(profit_margin) as prof_marg_2017_Q4 from transactions t join date d on t.order_date = d.date where year(order_date) = 2017;

/* (F.1.04) By aggregated quarter: */

select quarter,
avg(profit_margin) as prof_marg,
rank() over(order by sum(profit) desc) as prof_marg_rank
from transactions t join date d on t.order_date = d.date
group by 1
order by 1;



/* (F.2) Profit margin by customer: */

/* (F.2.01) Overall: */

SELECT 
    c.customer_code, customer_name, avg(profit_margin) as prof_marg, rank() over(order by count(transaction_code) desc) as prof_marg_rank
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 4;

/* (F.2.01a) Overall - Top 5 customers by profit margin: */

SELECT 
    c.customer_code, customer_name, avg(profit_margin) as prof_marg
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 3 DESC
LIMIT 5;

/* (F.2.01b) Overall - Bottom 5 customers by profit margin: */

SELECT 
    c.customer_code,
    customer_name,
    avg(profit_margin) as prof_marg
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1 , 2
ORDER BY 3
LIMIT 5;

/* (F.2.02) By customer_type: */

SELECT 
    customer_type,
    avg(profit_margin) as overall_prof_marg
FROM
    customers c
        JOIN
    transactions t ON c.customer_code = t.customer_code
GROUP BY 1
ORDER BY 2 DESC;




/* (F.3) Profit by markets (geography): */

/* (F.3.01) Overall: */

SELECT 
    m.market_name, avg(profit_margin) as prof_marg, rank() over(order by avg(profit_margin) desc) as prof_marg_rank
FROM
    markets m
        JOIN
    transactions t ON m.market_code= t.market_code
GROUP BY 1
ORDER BY 3;

/* (F.3.02) By zone: */

SELECT 
    zone,
    avg(profit_margin) as prof_marg,
    rank() over (order by avg(profit_margin) desc) as prof_marg_rank
FROM
    markets m
        JOIN
    transactions t ON m.market_code = t.market_code
GROUP BY 1
ORDER BY 2 DESC;




/* (F.4) Profit margin by product: */

/* (F.4.01) Overall: */

SELECT 
    p.product_code, avg(profit_margin) as prof_marg, rank() over(order by avg(profit_margin) desc) as prof_marg_rank
FROM
    products p
        JOIN
    transactions t ON p.product_code= t.product_code
GROUP BY 1
ORDER BY 3;

/* (F.4.01a) Overall - Top 5 products by profit margin: */

SELECT 
     p.product_code, avg(profit_margin) as prof_marg
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2
 DESC
LIMIT 5;

/* (F.4.01b) Overall - Bottom 5 products by profit margin: */

SELECT 
     p.product_code, avg(profit_margin) as prof_marg
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2
LIMIT 5;

/* (F.4.02) By product_type: */

SELECT 
    product_type,
    avg(profit_margin) as prof_marg
FROM
    products p
        JOIN
    transactions t ON p.product_code = t.product_code
GROUP BY 1
ORDER BY 2 DESC;
